version: '3.8'

services:
  test-backend:
    build:
      context: ../../
      dockerfile: backend/Dockerfile.test
    environment:
      - FLASK_ENV=testing
      - FLASK_DEBUG=False
      - DATABASE_URL=sqlite:////tmp/test.db
      - REDIS_URL=redis://test-redis:6379/1
      - JWT_SECRET_KEY=test-jwt-secret
      - SECRET_KEY=test-secret-key
    volumes:
      - ../../tests:/tests
    depends_on:
      - test-redis
    ports:
      - "5001:5000"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  test-frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile.test
    environment:
      - VITE_API_URL=http://test-backend:5000
      - NODE_ENV=test
    depends_on:
      - test-backend
    ports:
      - "3001:3000"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  test-redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 3

  test-runner:
    image: python:3.13-slim
    volumes:
      - .:/tests
      - ../../backend:/backend
      - ../../frontend:/frontend
    working_dir: /tests
    environment:
      - PYTHONPATH=/backend:/frontend
    command: pytest tests/ -v --cov=backend --cov=frontend/src
    depends_on:
      - test-backend
      - test-frontend
      - test-redis
    profiles:
      - test

  test-e2e:
    image: cypress/included:13.0.0
    volumes:
      - .:/tests
      - ../../frontend:/frontend
    working_dir: /tests
    environment:
      - CYPRESS_baseUrl=http://test-frontend:3000
    depends_on:
      - test-frontend
      - test-backend
    profiles:
      - e2e
